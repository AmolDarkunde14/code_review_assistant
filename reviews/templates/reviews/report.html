{% extends 'reviews/base.html' %}
{% block content %}
<div class="row">
  <div class="col-xxl-10 mx-auto">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h2 class="mb-0">{{ report.filename }}</h2>
        <div class="text-muted small">Uploaded: {{ report.created_at }}</div>
      </div>
      <div class="text-end">
        <!-- Show model status if available -->
        {% if report.review_text and 'LLM call' not in report.review_text %}
          <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i> Reviewed by Gemini</span>
        {% else %}
          <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle me-1"></i> Fallback used</span>
        {% endif %}
        <div class="mt-2">
          <a class="btn btn-outline-primary btn-sm me-2" href="{% url 'reviews:upload' %}"><i class="bi bi-upload me-1"></i> New upload</a>
          <button class="btn btn-primary btn-sm" onclick="exportReportPDF()"><i class="bi bi-file-earmark-pdf me-1"></i> Download PDF</button>
        </div>
      </div>
    </div>

    <div id="report-area">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <strong>Source code</strong>
              <div>
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="copyText('#code-block')"><i class="bi bi-clipboard"></i> Copy</button>
                <span class="badge bg-light text-dark">Preview</span>
              </div>
            </div>
            <div class="card-body">
              <pre class="language-python mb-0" id="code-block" style="white-space:pre-wrap;"><code>{{ report.code_content|escape }}</code></pre>
            </div>
          </div>

          <div class="mt-3 text-muted small">
            <strong>File:</strong> {{ report.filename }} &nbsp; • &nbsp; <strong>Length:</strong> {{ report.code_content|length }} chars
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header">
              <strong>LLM Review</strong>
            </div>
            <div class="card-body">
              {% if report.review_text %}
                <!-- Show important alert when fallback detected -->
                {% if 'Fallback checklist' in report.review_text or 'LLM call' in report.review_text %}
                  <div class="alert alert-warning">
                    <strong>Notice:</strong> The system used a fallback analysis (LLM call failed). The checklist below is a fallback and not model-generated.
                  </div>
                {% endif %}

                <!-- We'll show the full review but break into accordion sections for easy reading -->
                <div class="accordion" id="reviewAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSummary">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummary">Summary</button>
                    </h2>
                    <div id="collapseSummary" class="accordion-collapse collapse show" data-bs-parent="#reviewAccordion">
                      <div class="accordion-body" style="white-space:pre-wrap;">{{ report.review_text|linebreaksbr }}</div>
                    </div>
                  </div>
                </div>

                <!-- Raw review for copy/download -->
                <div class="mt-3">
                  <button class="btn btn-outline-secondary btn-sm me-2" onclick="copyText('#raw-review')"><i class="bi bi-clipboard"></i> Copy review</button>
                </div>

                <pre id="raw-review" class="mt-2" style="display:none;white-space:pre-wrap;">{{ report.review_text }}</pre>

              {% else %}
                <div class="text-muted">No review available.</div>
              {% endif %}
            </div>
            <div class="card-footer text-muted small">Use suggestions as guidance — review before applying.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'reviews:upload' %}"><i class="bi bi-arrow-left me-1"></i> Back</a>
      <button class="btn btn-success" onclick="exportReportPDF()"><i class="bi bi-printer me-1"></i> Save as PDF</button>
    </div>
  </div>
</div>

{% endblock %}
